//Last allocated time slot kiala ekak tiyaganna one
// eken allocate karanne eh time eka total journet time x 2 walta wadinam witarai
//Journey eka iwara wela bus eka available da nadda kiala danna one availble station eka danna one
busArray = [{
    busID: "bus1",
    noOfSeats: 50,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0
},
{
    busID: "bus2",
    noOfSeats: 47,
    route: "120",
    length: 18,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0
},
{
    busID: "bus3",
    noOfSeats: 50,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0
},
{
    busID: "bus4",
    noOfSeats: 53,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0
},
{
    busID: "bus5",
    noOfSeats: 55,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0
},
{
    busID: "bus6",
    noOfSeats: 55,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0
},
{
    busID: "bus7",
    noOfSeats: 58,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0
},
{
    busID: "bus8",
    noOfSeats: 47,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0
},
{
    busID: "bus9",
    noOfSeats: 48,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0
},
{
    busID: "bus10",
    noOfSeats: 50,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus11",
    noOfSeats: 50,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus12",
    noOfSeats: 55,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus13",
    noOfSeats: 58,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus14",
    noOfSeats: 47,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus15",
    noOfSeats: 48,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus16",
    noOfSeats: 50,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus17",
    noOfSeats: 50,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus18",
    noOfSeats: 53,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus19",
    noOfSeats: 58,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus20",
    noOfSeats: 59,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus21",
    noOfSeats: 48,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus22",
    noOfSeats: 45,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus23",
    noOfSeats: 50,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus24",
    noOfSeats: 50,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus25",
    noOfSeats: 50,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus26",
    noOfSeats: 50,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus27",
    noOfSeats: 50,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus28",
    noOfSeats: 50,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus29",
    noOfSeats: 50,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus30",
    noOfSeats: 50,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus31",
    noOfSeats: 50,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus32",
    noOfSeats: 50,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus33",
    noOfSeats: 50,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

},
{
    busID: "bus34",
    noOfSeats: 50,
    route: "120",
    length: 20,
    totalRevenue: 0,
    numberOfTurns: 0,
    revenueForTheIteration: 0

}]

// ,
// {
//     busID: "bus10",
//     noOfSeats: 50,
//     route: "120",
//     length: 20,
//     totalRevenue: 0,
//     numberOfTurns: 0,
//     revenueForTheIteration: 0

// },
// {
//     busID: "bus10",
//     noOfSeats: 50,
//     route: "120",
//     length: 20,
//     totalRevenue: 0,
//     numberOfTurns: 0,
//     revenueForTheIteration: 0

// },
// {
//     busID: "bus10",
//     noOfSeats: 50,
//     route: "120",
//     length: 20,
//     totalRevenue: 0,
//     numberOfTurns: 0,
//     revenueForTheIteration: 0

// },
// {
//     busID: "bus10",
//     noOfSeats: 50,
//     route: "120",
//     length: 20,
//     totalRevenue: 0,
//     numberOfTurns: 0,
//     revenueForTheIteration: 0

// },
// {
//     busID: "bus10",
//     noOfSeats: 50,
//     route: "120",
//     length: 20,
//     totalRevenue: 0,
//     numberOfTurns: 0,
//     revenueForTheIteration: 0

// },
// {
//     busID: "bus10",
//     noOfSeats: 50,
//     route: "120",
//     length: 20,
//     totalRevenue: 0,
//     numberOfTurns: 0,
//     revenueForTheIteration: 0

// },
// {
//     busID: "bus10",
//     noOfSeats: 50,
//     route: "120",
//     length: 20,
//     totalRevenue: 0,
//     numberOfTurns: 0,
//     revenueForTheIteration: 0

// },
// {
//     busID: "bus10",
//     noOfSeats: 50,
//     route: "120",
//     length: 20,
//     totalRevenue: 0,
//     numberOfTurns: 0,
//     revenueForTheIteration: 0

// }

var globalBest = -100;
var returnJSON = {
    allocation: {
        busAllocation: [],
        busIDs: []
    },
    message: "",
    fitnessValue: 0
};



console.log(generateSchedule(new Date("October 13, 2014 12:30:00"), new Date("October 13, 2014 13:30:00"), 15, 9, [60, 75, 68, 81, 90], busArray, 1000000));

function generateSchedule(startTime, endTime, fixedInterval, noOfBusses, avgPassengerCount, busArray, maxIterationCount) {
    let allSolutions = [];
    let totalTime = getHourDifference(startTime, endTime)
    let isValidInitialSolution = true;
    let initialSolution = []
    let noOfSlots = Math.round(totalTime / fixedInterval);
    let count = 0;
    if (noOfBusses < noOfSlots) {
        returnJSON.message = "Number of busses are not enough to generate the schedule atleast " + noOfSlots + " busses are needed";
        return returnJSON;
    } else if (noOfSlots > avgPassengerCount.length) {
        returnJSON.message = "Passenger average array is not enough to cover an optimal output\nNo of Slots : " + noOfSlots + "\nPassenger Average Array : " + avgPassengerCount.length;
        return returnJSON;
    }
    //Generate solutions and evaluvate untill maxiteration count exceed
    for (let r = 0; r < maxIterationCount; r++) {
        let previousGlobalSolution = JSON.parse(JSON.stringify(returnJSON.allocation.busAllocation));
        let validationCount = 0;
        do {
            //Intialize a new soluion
            initialSolution = generateInitialSolution(noOfSlots, noOfBusses);
            //Validating whether the generated solutions is arleady evaluvated or not
            outerloop: for (let i = 0; i < allSolutions.length; i++) {
                validationCount = validationCount + 1

                //Statement becomes true if all the possible solutions are already generated
                if (validationCount > allSolutions.length + 500) {
                    if (globalBest <= 0) {
                        // Generated solution is optimal for the given output But the number of busses are more than enough
                        returnJSON.message = "Dummy Message"
                        return returnJSON
                    } else {
                        return returnJSON
                    }
                }

                //Break from the loop and generate another solutions if the current solutions is already beign generated 
                if (allSolutions[i].toString() == initialSolution.toString()) {
                    isValidInitialSolution = false;
                    break outerloop;
                }
                //Change isValidInitialSolution true in order to break from the loop
                if (isValidInitialSolution == false) {
                    isValidInitialSolution = true;
                }
            }
        } while (!isValidInitialSolution);

        //Adding the current solutions to the all solution array(pool)
        allSolutions.push(initialSolution);
        //Swap elements and evaluvate
        allSolutions.push(swapSolutionElements(initialSolution, avgPassengerCount, busArray));
        if (returnJSON.allocation.busAllocation.toString() == previousGlobalSolution.toString()) {
            count++;
        } else {
            count = 0;
        }
        if (count > (maxIterationCount / 2)) {
            if (globalBest <= 0) {
                returnJSON.message = "Dummy Message"
                return returnJSON
            } else {
                return returnJSON
            }
        }
    }

    if (globalBest <= 0) {
        returnJSON.message = "Dummy Message"
        return returnJSON
    } else {
        return returnJSON
    }
}

function setReturnJSON(solution, passengerAverage) {
    for (let i = 0; i < solution.length; i++) {
    }
}

function getHourDifference(dt1, dt2) {
    let diff = dt2 - dt1;
    return Math.floor((diff / 1000) / 60);
}

function generateInitialSolution(noOfSlots, noOfBusses) {

    let solution = []
    var maxValue = (noOfBusses - noOfSlots) + 1;
    let minValue = 1;
    let currentSum = 0;
    let randomValue = 0;
    let isValidRandom;


    for (let i = noOfSlots; i > 0; i--) {
        // if (i >= (noOfSlots / 2)) {
        //     maxValue = maxValue/2;
        // }


        let sumOfCurrentSolution = solution.reduce((a, b) => a + b, 0);
        let maxRandomForCurrrentIteration = noOfBusses - sumOfCurrentSolution - i + 1;
        if (i == 1) {
            randomValue = maxRandomForCurrrentIteration;
        } else {
            do {
                randomValue = Math.floor((Math.random() * maxValue) + minValue)
                isValidRandom = (maxRandomForCurrrentIteration >= randomValue)
            } while (!isValidRandom);
        }
        do {
            isValidRandom = validateRandomValue((currentSum + randomValue), noOfBusses)
        }
        while (!isValidRandom);
        currentSum = currentSum + randomValue;

        solution.push(randomValue);

    }

    return solution;

}


function validateRandomValue(currentSum, noOfBusses) {
    return currentSum <= noOfBusses;
}


function swapSolutionElements(originalSolution, passengerAverage, busArray) {
    for (let i = 0; i < originalSolution.length; i++) {
        let solution = JSON.parse(JSON.stringify(originalSolution));
        for (let r = i; r < originalSolution.length; r++) {
            let returnEvaluvateSolution = evaluvateSolution(solution, passengerAverage, busArray);
            console.log(returnEvaluvateSolution);
            console.log("******** " + solution);
            console.log("\n")
            fitnessValue = returnEvaluvateSolution.fitnessValue;
            if (globalBest == fitnessValue) {
                returnJSON.allocation.busAllocation = JSON.parse(JSON.stringify(solution));
                returnJSON.allocation.busIDs = returnEvaluvateSolution.busIDs
                returnJSON.fitnessValue = fitnessValue
            }
            if (globalBest < fitnessValue) {
                globalBest = fitnessValue;
                returnJSON.allocation.busAllocation = JSON.parse(JSON.stringify(solution));
                returnJSON.allocation.busIDs = returnEvaluvateSolution.busIDs
                returnJSON.fitnessValue = fitnessValue
            }
            if (r != solution.length - 1) {
                let temp = solution[i];
                solution[i] = solution[r + 1];
                solution[r + 1] = temp;
            }

        }

    }
    return returnJSON.allocation.busAllocation;
}


function evaluvateSolution(solution, passengerAverage, busArray) {
    let spliceIndex = 0;
    let isEnoughSeats = false;
    let returnEvaluvateJSON = {
        busIDs: [],
        fitnessValue: 0
    }

    for (let i = 0; i < solution.length; i++) {
        let sumOfSeats = 0;
        let spliceArray = JSON.parse(JSON.stringify(busArray));


        let newBusArray = spliceArray.splice(spliceIndex, solution[i])
        spliceIndex = spliceIndex + solution[i];
        newBusArray = JSON.parse(JSON.stringify(newBusArray));


        for (let r = 0; r < newBusArray.length; r++) {
            sumOfSeats = sumOfSeats + newBusArray[r].noOfSeats;
            if (r == 0) {
                returnEvaluvateJSON.busIDs[i] = newBusArray[r].busID;
            } else {
                returnEvaluvateJSON.busIDs[i] += "," + newBusArray[r].busID;
            }

        }

        let slack = sumOfSeats - passengerAverage[i];
        if (slack >= 0) {
            isEnoughSeats = true;
        } else {
            isEnoughSeats = false;
        }



        if (slack < -10) {
            returnEvaluvateJSON.fitnessValue = returnEvaluvateJSON.fitnessValue - 0.5;
        } else if (slack < 0) {
            returnEvaluvateJSON.fitnessValue = returnEvaluvateJSON.fitnessValue - 1;
        } else if (slack > 100) {
            returnEvaluvateJSON.fitnessValue = returnEvaluvateJSON.fitnessValue - 5.2;
        } else if (slack > 90) {
            returnEvaluvateJSON.fitnessValue = returnEvaluvateJSON.fitnessValue - 4.1;
        } else if (slack > 80) {
            returnEvaluvateJSON.fitnessValue = returnEvaluvateJSON.fitnessValue - 3;
        } else if (slack > 70) {
            returnEvaluvateJSON.fitnessValue = returnEvaluvateJSON.fitnessValue - 1.9;
        } else if (slack > 60) {
            returnEvaluvateJSON.fitnessValue = returnEvaluvateJSON.fitnessValue - 0.8;
        } else if (slack > 50) {
            returnEvaluvateJSON.fitnessValue = returnEvaluvateJSON.fitnessValue - 0.7;
        } else if (slack > 40) {
            returnEvaluvateJSON.fitnessValue = returnEvaluvateJSON.fitnessValue - 0.6;
        } else if (slack > 30) {
            returnEvaluvateJSON.fitnessValue = returnEvaluvateJSON.fitnessValue - 0.5;
        } else if (slack > 20) {
            returnEvaluvateJSON.fitnessValue = returnEvaluvateJSON.fitnessValue + 0;
        } else if (slack > 5) {
            returnEvaluvateJSON.fitnessValue = returnEvaluvateJSON.fitnessValue + 1.5;
        } else if (slack > 0) {
            returnEvaluvateJSON.fitnessValue = returnEvaluvateJSON.fitnessValue + 1;
        }

        // let sortedArray = JSON.parse(JSON.stringify(solution));
        // let passengerAverageArray = JSON.parse(JSON.stringify(passengerAverage));
        // sortedArray.sort(function (a, b) { return b - a });
        // if (isEnoughSeats && i == solution.length - 1) {
        //     for (let k = 0; k < sortedArray.length; k++) {

        //         let maxValueOfTheSolution = solution.indexOf(sortedArray[k])
        //         let maxValueOfThePassengerAverage = passengerAverage.indexOf(Math.max(...passengerAverageArray));
        //         if (maxValueOfTheSolution != maxValueOfThePassengerAverage) {
        //             returnEvaluvateJSON.fitnessValue = -1500
        //         } else {
        //             passengerAverageArray.splice(maxValueOfThePassengerAverage, 1);
        //             sortedArray.splice(maxValueOfTheSolution, 1);
        //         }
        //     }
        // }

        // for (let k = 0; k < passengerAverage.length - 1; k++) {

        //     if (passengerAverage[k] > passengerAverage[k + 1]) {
        //         if (solution[k] < solution[k + 1]) {
        //             returnEvaluvateJSON.fitnessValue = -1500
        //         }
        //     } else {
        //         if (solution[k] > solution[k + 1]) {
        //             returnEvaluvateJSON.fitnessValue = -1500
        //         }
        //     }


        // }

        //Evaluvating whether the busses are divided in a proper way if the number of busses are more than the actual need
        for (let k = 0; k < passengerAverage.length - 1; k++) {
            for (let j = 0; j < passengerAverage.length; j++) {
                if (passengerAverage[k] > passengerAverage[j]) {
                    if (solution[k] < solution[j]) {
                        returnEvaluvateJSON.fitnessValue = returnEvaluvateJSON.fitnessValue - 0.5
                    } else {
                        returnEvaluvateJSON.fitnessValue = returnEvaluvateJSON.fitnessValue + 0.05
                    }
                } else {
                    if (solution[k] > solution[j]) {
                        returnEvaluvateJSON.fitnessValue = returnEvaluvateJSON.fitnessValue - 0.5
                    } else {
                        returnEvaluvateJSON.fitnessValue = returnEvaluvateJSON.fitnessValue + 0.05
                    }
                }

            }


        }


    }

    return returnEvaluvateJSON;
}



